
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro • Jo Nails</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f7fb}
    .wrap{max-width:560px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 28px #0001;padding:18px}
    h1{margin:0 0 12px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px}
    button{padding:12px 16px;border:0;border-radius:12px;background:#a78bfa;color:#fff;font-weight:700;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:#6b7280}
    .out{word-break:break-all;background:#f8fafc;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
    .qr{display:grid;place-items:center;margin-top:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>¡Consigue tu tarjeta!</h1>
      <p class="muted">Regístrate y te generamos tu tarjeta con QR para acumular sellos.</p>

      <div id="form">
        <label>Nombre</label>
        <input id="name" placeholder="Ej. Alex">
        <label>Teléfono (WhatsApp)</label>
        <input id="phone" placeholder="Ej. 3331234567">
        <div class="row" style="margin-top:12px">
          <button id="go">Obtener mi QR</button>
          <span id="status" class="muted" style="align-self:center"></span>
        </div>
      </div>

      <div id="result" style="display:none">
        <h3>¡Listo! Esta es tu tarjeta:</h3>
        <div class="out" id="linkBox"></div>
        <div class="qr">
          <img id="qr" alt="QR de tu tarjeta" width="200" height="200" />
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const status = msg => { el('status').textContent = msg; };

    async function registrar(){
      const name = el('name').value.trim();
      const phone = el('phone').value.trim();
      if(!name || !phone){ status('Completa nombre y teléfono'); return; }

      status('Procesando…');
      el('go').disabled = true;

      try{
        const r = await fetch('/.netlify/functions/create_customer', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, phone })
        });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.msg || j.error || 'Error');

        const { id } = j.data;
        const cardUrl = `${location.origin}/tarjeta.html?id=${encodeURIComponent(id)}`;

        // Mostrar resultado
        el('form').style.display = 'none';
        el('result').style.display = 'block';
        el('linkBox').textContent = cardUrl;

        // Generar QR (servicio simple, sin librerías)
        el('qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(cardUrl)}`;

        status('');
      }catch(e){
        status('');
        alert('Error: ' + e.message);
        el('go').disabled = false;
      }
    }

    el('go').onclick = (e)=>{ e.preventDefault(); registrar(); };
  </script>
</body>
</html>
