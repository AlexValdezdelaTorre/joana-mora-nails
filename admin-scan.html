
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jo ‚Ä¢ Esc√°ner de tarjetas</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:24px;background:#f7f7fb}
    .wrap{max-width:560px;margin:auto}
    #reader{width:100%;min-height:320px;border-radius:14px;overflow:hidden;background:#0001}
    .box{background:#fff;border-radius:14px;padding:14px;margin-top:14px;box-shadow:0 10px 24px #0001}
    input,button{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
    button{background:#A78BFA;color:#fff;border:0;font-weight:700;cursor:pointer}
    .ok{color:#16a34a} .err{color:#dc2626}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Escanear tarjeta</h2>
    <div id="reader" class="box"></div>
    <div class="box" style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
  <button id="swapCam" style="padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb;">
    Cambiar c√°mara
  </button>
</div>


    <div class="box">
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <input id="id" placeholder="ID del cliente (UUID)" style="flex:1" />
        <input id="pin" placeholder="PIN" type="password" style="width:120px" />
        <button id="btn">+1 sello</button>
        
        <button id="redeem5"  style="background:#f59e0b">Canjear 5</button>
        <button id="redeem10" style="background:#ef4444">Canjear 10</button>

      </div>
      <div id="status" style="margin-top:8px;color:#6b7280">Escanea un QR o pega un ID.</div>
    </div>
  </div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
  // ====== Esc√°ner (elige trasera por defecto y permite alternar) ======
  const reader = new Html5Qrcode("reader");
  let cams = [];
  let idx = 0; // √≠ndice de c√°mara actual

  function onScan(text){
    try{
      const u = new URL(text);
      const got = new URLSearchParams(u.search).get("id");
      if(got){
        document.getElementById('id').value = got;
        setStatus(`‚úÖ Detectado ID: ${got}`,'ok');
      }
    }catch(e){
      // QR no es URL, lo ignoramos silenciosamente
    }
  }

  async function startCam(){
    // Det√©n si hab√≠a una c√°mara activa
    try { await reader.stop(); } catch(_) {}

    const selected = cams[idx];
    try{
      if (selected) {
        await reader.start(selected.id, { fps: 10, qrbox: 250 }, onScan);
      } else {
        // Fallback si no tenemos lista de c√°maras (intenta back camera por facingMode)
        await reader.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan);
      }
      setStatus('C√°mara lista');
    }catch(e){
      setStatus('No se pudo iniciar la c√°mara: ' + e.message, 'err');
    }
  }

  // Detecta c√°maras y prioriza la trasera
  Html5Qrcode.getCameras().then(devs=>{
    cams = devs || [];
    const backIx = cams.findIndex(d => /back|rear|environment|tr√°s|atras|atr√°s/i.test(d.label));
    idx = backIx >= 0 ? backIx : 0;
    startCam();
  }).catch(()=>{
    // Sin lista de c√°maras, intenta facingMode
    startCam();
  });

  // Bot√≥n para alternar entre c√°maras disponibles
  document.getElementById('swapCam').onclick = () => {
    if (!cams.length) { setStatus('No hay m√°s c√°maras para alternar','err'); return; }
    idx = (idx + 1) % cams.length;
    startCam();
  };

  // ====== Llamar a la funci√≥n serverless (sumar sello) ======
  async function stamp(){
    const id  = document.getElementById('id').value.trim();
    const pin = document.getElementById('pin').value.trim();
    if(!id || !pin) return setStatus('Falta ID o PIN','err');

    setStatus('Enviando‚Ä¶');
    try{
      const r = await fetch('/.netlify/functions/stamp', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, pin })
      });
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.msg || j.error || 'Error');
      const newStamps = j.data?.[0]?.stamps ?? '‚Äî';
      setStatus(`üéâ Sello sumado. Total: ${newStamps}`, 'ok');
    }catch(e){
      setStatus('‚ùå ' + e.message, 'err');
    }
  }
  document.getElementById('btn').onclick = stamp;

  function setStatus(msg, cls=''){
    const el = document.getElementById('status');
    el.className = cls;
    el.textContent = msg;
  }
    async function redeem(need){
    const id  = document.getElementById('id').value.trim();
    const pin = document.getElementById('pin').value.trim();
    if(!id || !pin) return setStatus('Falta ID o PIN','err');

    setStatus(`Canjeando ${need}‚Ä¶`);
    try{
      const r = await fetch('/.netlify/functions/redeem_reward', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, pin, need })
      });
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.msg || j.error || 'Error');
      setStatus(`üéÅ Canjeado ${need}. Total ahora: ${j.after}`, 'ok');
    }catch(e){
      setStatus('‚ùå ' + e.message, 'err');
    }
  }

  document.getElementById('redeem5').onclick  = () => redeem(5);
  document.getElementById('redeem10').onclick = () => redeem(10);
</script>
</script>